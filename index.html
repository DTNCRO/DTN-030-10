import React, { useState, useEffect, useCallback, useMemo } from 'react';

// Firebase Imports
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, onSnapshot, setDoc, Timestamp } from 'firebase/firestore';

// --- CONFIGURATION ---
const COLLECTION_PATH = 'hplc_maintenance'; 
const DOC_ID = 'hplc01'; 
// 기본값은 365일(1년)로 설정하지만, 관리자 모드에서 변경 가능합니다.
const DEFAULT_INTERVAL = 365; 

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- Utility Functions ---
const calculateDDay = (dateString) => {
    if (!dateString) return null;
    const target = new Date(dateString);
    target.setHours(0, 0, 0, 0);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const diffTime = target.getTime() - today.getTime();
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
};

const formatDate = (dateInput) => {
    if (!dateInput) return '미정';
    const date = typeof dateInput === 'string' ? new Date(dateInput) : dateInput;
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}.${month}.${day}`;
};

// --- Default Data ---
const DEFAULT_DATA = {
    deviceName: "DTN-030-6",
    modelName: "Sciex",
    status: "정상 가동 중",
    serialNo: "DE12345678",
    acquisitionDate: "2022.01.10",
    lastInspectionDate: "2024-03-15",
    nextInspectionDate: "2025-03-15",
    intervalDays: DEFAULT_INTERVAL, // 점검 주기 데이터 추가
    contactPerson: "김담당",
    contactPhone: "010-1234-5678",
    contactEmail: "kim.manager@lab.com",
    links: {
        sopLink: "#",
        manualPdf: "#",
        logExcel: "#",
        troubleshoot: "#", 
        partsInfo: "#" 
    }
};

// --- REACT MAIN COMPONENT ---
const App = () => {
    const [db, setDb] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);

    const [deviceData, setDeviceData] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);

    const [isEditMode, setIsEditMode] = useState(false);
    const [isUpdating, setIsUpdating] = useState(false);
    const [message, setMessage] = useState(null);
    const [showContactModal, setShowContactModal] = useState(false);

    // Form Temporary State
    const [tempDeviceName, setTempDeviceName] = useState("");
    const [tempModelName, setTempModelName] = useState("");
    const [tempStatus, setTempStatus] = useState("정상 가동 중");
    const [tempSerialNo, setTempSerialNo] = useState("");
    const [tempAcquisitionDate, setTempAcquisitionDate] = useState("");
    const [tempContactPerson, setTempContactPerson] = useState(""); 
    const [tempContactPhone, setTempContactPhone] = useState("");
    const [tempContactEmail, setTempContactEmail] = useState("");
    const [tempLinkSop, setTempLinkSop] = useState("");
    const [tempIntervalDays, setTempIntervalDays] = useState(DEFAULT_INTERVAL); // 점검 주기 수정용 상태

    // 1. Firebase Initialization
    useEffect(() => {
        let unsubscribe = () => {};
        try {
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const authInstance = getAuth(app);
            setDb(firestore);

            const performAuth = async () => {
                try {
                    if (initialAuthToken) await signInWithCustomToken(authInstance, initialAuthToken);
                    else await signInAnonymously(authInstance);
                } catch (e) { console.error("Auth failed:", e); }
            };
            performAuth();

            unsubscribe = onAuthStateChanged(authInstance, (user) => {
                if (user) { setUserId(user.uid); setIsAuthReady(true); }
            });
            return () => unsubscribe();
        } catch (e) { console.error("Init Error:", e); setError("초기화 오류"); }
    }, []);

    // 2. Real-time Data Fetching
    useEffect(() => {
        if (!db || !isAuthReady) return;
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_PATH, DOC_ID);
        const unsubscribe = onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                const mergedData = { ...DEFAULT_DATA, ...data, links: { ...DEFAULT_DATA.links, ...data.links } };
                setDeviceData(mergedData);
            } else {
                setDoc(docRef, DEFAULT_DATA);
                setDeviceData(DEFAULT_DATA);
            }
            setIsLoading(false);
        }, (err) => { setError("데이터 로딩 실패"); setIsLoading(false); });
        return () => unsubscribe();
    }, [db, isAuthReady]);

    // Computed Values
    const lastDate = deviceData?.lastInspectionDate;
    const nextDate = deviceData?.nextInspectionDate;
    const interval = deviceData?.intervalDays || DEFAULT_INTERVAL; // 현재 설정된 주기
    const dDay = useMemo(() => calculateDDay(nextDate), [nextDate]);
    const dDayText = dDay === null ? '미정' : dDay > 0 ? `D-${dDay}` : dDay === 0 ? 'D-DAY' : `D+${Math.abs(dDay)}`;
    
    const statusColor = useMemo(() => {
        switch (deviceData?.status) {
            case '수리중': return 'bg-red-500/90';
            case '점검중': return 'bg-yellow-500/90';
            case '사용중': return 'bg-blue-500/90';
            default: return 'bg-white/20';
        }
    }, [deviceData?.status]);
    
    const dDayColor = dDay === null || dDay > 7 ? 'text-green-600 bg-green-100' : (dDay > 0 ? 'text-yellow-600 bg-yellow-100' : 'text-red-600 bg-red-100');

    // 3. Toggle Edit Mode
    const toggleEditMode = () => {
        if (!isEditMode && deviceData) {
            setTempDeviceName(deviceData.deviceName || "");
            setTempModelName(deviceData.modelName || "");
            setTempStatus(deviceData.status || "정상 가동 중");
            setTempSerialNo(deviceData.serialNo || "");
            setTempAcquisitionDate(deviceData.acquisitionDate || "");
            setTempContactPerson(deviceData.contactPerson || ""); 
            setTempContactPhone(deviceData.contactPhone || "");
            setTempContactEmail(deviceData.contactEmail || "");
            setTempLinkSop(deviceData.links?.sopLink || "");
            setTempIntervalDays(deviceData.intervalDays || DEFAULT_INTERVAL); // 주기 불러오기
        }
        setIsEditMode(prev => !prev);
    };

    // 4. Handlers
    const handleLogInspection = useCallback(async () => {
        if (!db || !userId) return;
        setIsUpdating(true); setMessage(null);
        try {
            const currentInterval = deviceData?.intervalDays || DEFAULT_INTERVAL;
            const today = new Date(); today.setHours(0,0,0,0);
            const newLast = today.toISOString().split('T')[0];
            
            // 설정된 주기만큼 더해서 다음 점검일 계산
            const nextCalc = new Date(today); 
            nextCalc.setDate(today.getDate() + parseInt(currentInterval));
            const newNext = nextCalc.toISOString().split('T')[0];

            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_PATH, DOC_ID), {
                lastInspectionDate: newLast, nextInspectionDate: newNext, updatedAt: Timestamp.now(), updatedBy: userId
            }, { merge: true });
            setMessage(`✅ 점검 완료! 차기 점검일(${currentInterval}일 후): ${formatDate(newNext)}`);
        } catch (e) { setMessage(`❌ 실패: ${e.message}`); } 
        finally { setIsUpdating(false); setTimeout(() => setMessage(null), 5000); }
    }, [db, userId, deviceData]);

    const handleUpdateDeviceInfo = useCallback(async () => {
        if (!db || !userId) return;
        setIsUpdating(true); setMessage(null);
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_PATH, DOC_ID), {
                deviceName: tempDeviceName, modelName: tempModelName, status: tempStatus,
                serialNo: tempSerialNo, acquisitionDate: tempAcquisitionDate,
                contactPerson: tempContactPerson, contactPhone: tempContactPhone, contactEmail: tempContactEmail,
                intervalDays: parseInt(tempIntervalDays), // 주기 저장
                links: { ...deviceData.links, sopLink: tempLinkSop },
                updatedAt: Timestamp.now(), updatedBy: userId
            }, { merge: true });
            setMessage("✅ 정보가 저장되었습니다.");
        } catch (e) { setMessage(`❌ 실패: ${e.message}`); } 
        finally { setIsUpdating(false); setTimeout(() => setMessage(null), 5000); }
    }, [db, userId, tempDeviceName, tempModelName, tempStatus, tempSerialNo, tempAcquisitionDate, tempContactPerson, tempContactPhone, tempContactEmail, tempLinkSop, tempIntervalDays, deviceData]);


    // Contact Modal
    const ContactModal = () => (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-50 p-4" onClick={() => setShowContactModal(false)}>
            <div className="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm transform transition-all scale-100" onClick={(e) => e.stopPropagation()}>
                <div className="flex items-center mb-6">
                    <div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 mr-3">
                        <i className="fa-solid fa-user-check text-lg"></i>
                    </div>
                    <h3 className="text-xl font-bold text-gray-800">기기 담당자</h3>
                </div>
                <div className="space-y-4 text-gray-700 mb-6">
                    <div className="bg-gray-50 p-3 rounded-xl border border-gray-100">
                        <p className="text-xs text-gray-500 mb-1">담당자명</p>
                        <p className="font-bold text-lg text-gray-800">{deviceData.contactPerson || '미정'}</p>
                    </div>
                    <div className="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-xl hover:border-blue-300 transition">
                        <div>
                            <p className="text-xs text-gray-500">연락처</p>
                            <p className="font-semibold text-gray-800">{deviceData.contactPhone || '미정'}</p>
                        </div>
                        <a href={`tel:${deviceData.contactPhone}`} className="w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center"><i className="fa-solid fa-phone"></i></a>
                    </div>
                    <div className="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-xl hover:border-blue-300 transition">
                        <div className="overflow-hidden">
                            <p className="text-xs text-gray-500">이메일</p>
                            <p className="font-semibold text-gray-800 truncate text-sm">{deviceData.contactEmail || '미정'}</p>
                        </div>
                        <a href={`mailto:${deviceData.contactEmail}`} className="w-8 h-8 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center"><i className="fa-solid fa-envelope"></i></a>
                    </div>
                </div>
                <button onClick={() => setShowContactModal(false)} className="w-full py-3 bg-gray-900 text-white rounded-xl font-bold hover:bg-gray-800 transition shadow-lg">
                    닫기
                </button>
            </div>
        </div>
    );

    if (error) return <div className="p-10 text-center text-red-500">{error}</div>;
    if (isLoading || !isAuthReady || !deviceData) return <div className="flex justify-center items-center h-screen"><i className="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>;

    return (
        <div className="min-h-screen bg-gray-100 p-4 font-sans">
            <style>{`
                @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
                body { font-family: 'Noto Sans KR', sans-serif; }
                .form-input, .form-select { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white; }
                .form-input:focus { border-color: #3b82f6; outline: none; ring: 2px; ring-color: #bfdbfe; }
            `}</style>

            <div className="max-w-md mx-auto bg-white rounded-[30px] shadow-2xl overflow-hidden border border-gray-100">
                
                {/* Header */}
                <div className="bg-gradient-to-br from-blue-600 to-cyan-500 p-8 text-white rounded-b-[40px] shadow-lg relative z-10">
                    <div className="text-center">
                        <div className={`inline-flex items-center ${statusColor} px-4 py-1.5 rounded-full mb-3 backdrop-blur-md shadow-sm border border-white/20`}>
                            <div className={`w-2 h-2 rounded-full mr-2 ${deviceData.status === '정상 가동 중' ? 'bg-green-400' : 'bg-yellow-400'} animate-pulse`}></div>
                            <span className="text-xs font-bold tracking-wide">{deviceData.status}</span>
                        </div>
                        <h1 className="text-3xl font-extrabold tracking-tight mb-1 text-shadow-sm">{deviceData.deviceName}</h1>
                        <p className="text-sm text-blue-50 font-medium opacity-90">{deviceData.modelName}</p>
                    </div>
                </div>

                <div className="px-6 -mt-6 relative z-20 space-y-6 pb-10">
                    
                    {/* SOP Link Card (수정됨: 이름 변경) */}
                    <a href={deviceData.links?.sopLink || "#"} target="_blank" rel="noopener noreferrer" 
                       className="block bg-white p-4 rounded-2xl shadow-md border border-yellow-100 flex items-center justify-between hover:shadow-lg transition transform active:scale-[0.98] group ring-1 ring-black/5">
                        <div className="flex items-center">
                            <div className="w-12 h-12 bg-yellow-50 text-yellow-600 rounded-xl flex items-center justify-center text-xl mr-4 group-hover:bg-yellow-100 transition">
                                <i className="fa-solid fa-link"></i>
                            </div>
                            <div>
                                <p className="text-xs font-bold text-yellow-600 uppercase tracking-wider">LINK</p>
                                {/* 이름 수정됨 */}
                                <p className="font-bold text-gray-800 text-lg">SOP 접속 링크</p>
                            </div>
                        </div>
                        <div className="w-8 h-8 bg-gray-50 rounded-full flex items-center justify-center text-gray-400 group-hover:bg-yellow-500 group-hover:text-white transition">
                            <i className="fa-solid fa-arrow-right"></i>
                        </div>
                    </a>

                    {/* 4-Tab Menu Grid (수정됨: 이름 사진과 동일하게, 부가설명 제거) */}
                    <div className="grid grid-cols-2 gap-4">
                        {[
                            { title: "기기 매뉴얼", icon: "fa-book", color: "text-blue-600", bg: "bg-blue-50", link: deviceData.links?.manualPdf },
                            { title: "기기이력", icon: "fa-clock-rotate-left", color: "text-green-600", bg: "bg-green-50", link: deviceData.links?.logExcel },
                            { title: "고장 시 접수", icon: "fa-triangle-exclamation", color: "text-orange-500", bg: "bg-orange-50", link: deviceData.links?.troubleshoot },
                            { title: "부품 보유 현황 및 정보", icon: "fa-boxes-stacked", color: "text-purple-600", bg: "bg-purple-50", link: deviceData.links?.partsInfo }
                        ].map((item, idx) => (
                            <a key={idx} href={item.link || "#"} target="_blank" rel="noopener noreferrer" 
                               className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition flex flex-col items-center text-center active:bg-gray-50 justify-center h-32">
                                <div className={`w-12 h-12 ${item.bg} ${item.color} rounded-xl flex items-center justify-center text-2xl mb-3`}>
                                    <i className={`fa-solid ${item.icon}`}></i>
                                </div>
                                {/* 부가 설명 제거하고 폰트 조정 */}
                                <span className="font-bold text-gray-800 text-sm leading-tight">{item.title}</span>
                            </a>
                        ))}
                    </div>

                    {/* Inspection Schedule Card */}
                    <div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                        <div className="flex justify-between items-center mb-4 pb-4 border-b border-gray-50">
                            <h3 className="font-bold text-gray-800 flex items-center">
                                <i className="fa-solid fa-calendar-day text-blue-500 mr-2"></i> 점검 일정
                            </h3>
                            <span className={`px-3 py-1 rounded-full text-xs font-extrabold ${dDayColor}`}>{dDayText}</span>
                        </div>
                        <div className="flex justify-between text-sm">
                            <div className="text-center w-1/2 border-r border-gray-100">
                                <p className="text-xs text-gray-400 mb-1">최근 점검일</p>
                                <p className="font-semibold text-gray-700">{formatDate(lastDate)}</p>
                            </div>
                            <div className="text-center w-1/2">
                                <p className="text-xs text-gray-400 mb-1">차기 점검일</p>
                                <p className="font-bold text-blue-600">{formatDate(nextDate)}</p>
                            </div>
                        </div>
                        <div className="text-center mt-3">
                             <span className="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded">점검 주기: {interval}일</span>
                        </div>
                    </div>

                    {/* Device Info Card */}
                    <div className="bg-gray-50 rounded-2xl p-5 border border-gray-200/60">
                        <h3 className="font-bold text-gray-800 mb-3 text-sm flex items-center">
                            <i className="fa-solid fa-circle-info text-gray-400 mr-2"></i> 기기 정보
                        </h3>
                        <div className="space-y-2 text-sm">
                            <div className="flex justify-between">
                                <span className="text-gray-500">Serial No.</span>
                                <span className="font-medium text-gray-800 tracking-wider">{deviceData.serialNo}</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-500">도입일자</span>
                                <span className="font-medium text-gray-800">{deviceData.acquisitionDate}</span>
                            </div>
                        </div>
                    </div>

                    {/* Contact Button */}
                    <button onClick={() => setShowContactModal(true)} 
                        className="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-gray-800 transition flex items-center justify-center">
                        <i className="fa-solid fa-headset mr-2"></i> 기기 담당자 연결
                    </button>

                    {/* Admin Mode Toggle */}
                    <div className="text-center pt-4">
                        <button onClick={toggleEditMode} className="text-xs text-gray-400 hover:text-gray-600 font-medium underline decoration-gray-300 underline-offset-4">
                            {isEditMode ? '관리자 모드 닫기' : '관리자 설정'}
                        </button>
                    </div>

                    {/* --- ADMIN MODE PANEL --- */}
                    {isEditMode && (
                        <div className="bg-white border-2 border-blue-100 rounded-2xl p-5 shadow-xl animate-fade-in-down">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="font-bold text-blue-900">⚙️ 관리자 설정</h3>
                                <span className="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold">Admin</span>
                            </div>
                            
                            {message && <div className={`p-3 mb-4 text-xs rounded-lg font-bold ${message.startsWith('✅')?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>{message}</div>}

                            <div className="space-y-6">
                                {/* Inspection Update */}
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-2 uppercase">점검 기록</label>
                                    <button onClick={handleLogInspection} disabled={isUpdating} className="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-bold text-sm shadow-md transition disabled:opacity-50">
                                        {isUpdating ? '처리 중...' : `오늘 날짜로 점검 완료 처리`}
                                    </button>
                                </div>

                                {/* Basic Info Edit */}
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-2 uppercase">기기 정보 및 주기 수정</label>
                                    <div className="grid grid-cols-2 gap-3 mb-3">
                                        <input type="text" placeholder="기기명" className="form-input" value={tempDeviceName} onChange={e=>setTempDeviceName(e.target.value)} />
                                        <select className="form-select" value={tempStatus} onChange={e=>setTempStatus(e.target.value)}>
                                            <option>정상 가동 중</option><option>수리중</option><option>점검중</option><option>사용중</option>
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 mb-3">
                                        <input type="text" placeholder="모델명" className="form-input" value={tempModelName} onChange={e=>setTempModelName(e.target.value)} />
                                        {/* 점검 주기 수정 필드 추가 */}
                                        <div className="relative">
                                            <input type="number" placeholder="주기(일)" className="form-input" value={tempIntervalDays} onChange={e=>setTempIntervalDays(e.target.value)} />
                                            <span className="absolute right-3 top-3 text-xs text-gray-400">일 간격</span>
                                        </div>
                                    </div>
                                    <input type="text" placeholder="SOP 링크 URL" className="form-input mb-3 border-yellow-300 bg-yellow-50" value={tempLinkSop} onChange={e=>setTempLinkSop(e.target.value)} />
                                </div>

                                {/* Contact Info Edit */}
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-2 uppercase">담당자 정보 수정</label>
                                    <input type="text" placeholder="이름" className="form-input mb-3" value={tempContactPerson} onChange={e=>setTempContactPerson(e.target.value)} />
                                    <div className="grid grid-cols-2 gap-3">
                                        <input type="text" placeholder="연락처" className="form-input" value={tempContactPhone} onChange={e=>setTempContactPhone(e.target.value)} />
                                        <input type="email" placeholder="이메일" className="form-input" value={tempContactEmail} onChange={e=>setTempContactEmail(e.target.value)} />
                                    </div>
                                </div>

                                <button onClick={handleUpdateDeviceInfo} disabled={isUpdating} className="w-full bg-gray-800 hover:bg-gray-900 text-white py-3 rounded-xl font-bold text-sm shadow-md transition disabled:opacity-50">
                                    전체 정보 저장
                                </button>
                            </div>
                        </div>
                    )}

                </div>
                
                {showContactModal && <ContactModal />}
            </div>
        </div>
    );
};

export default App;
