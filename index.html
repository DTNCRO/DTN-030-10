<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPLC 기기 관리</title>
    
    <!-- 라이브러리 로드 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; }
        .form-input, .form-select { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white; }
        .form-input:focus, .form-select:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px #bfdbfe; }
        .animate-fade-in-down { animation: fade-in-down 0.3s ease-out; }
        @keyframes fade-in-down { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- ★ Firebase 설정 (점검일 저장용, 없으면 화면만 작동) ★ ---
        const firebaseConfig = {
            apiKey: "여기에_API_KEY_입력",
            authDomain: "여기에_AUTH_DOMAIN_입력",
            projectId: "여기에_PROJECT_ID_입력",
            storageBucket: "여기에_STORAGE_BUCKET_입력",
            messagingSenderId: "여기에_SENDER_ID_입력",
            appId: "여기에_APP_ID_입력"
        };

        // Firebase 초기화
        let db, auth;
        try {
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "여기에_API_KEY_입력") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
            }
        } catch (e) { console.error(e); }

        const COLLECTION_PATH = 'hplc_maintenance';
        const DOC_ID = 'hplc01';
        const DEFAULT_INTERVAL = 365;

        // --- ★★★ 여기에 링크와 기기 정보를 직접 입력하세요 ★★★ ---
        const DEFAULT_DATA = {
            deviceName: "DTN-030-6",
            modelName: "Sciex",
            status: "정상 가동 중",
            serialNo: "DE12345678",
            acquisitionDate: "2022.01.10",
            lastInspectionDate: "2024-03-15",
            nextInspectionDate: "2025-03-15",
            intervalDays: DEFAULT_INTERVAL,
            contactPerson: "김담당",
            contactPhone: "010-1234-5678",
            contactEmail: "kim.manager@lab.com",
            links: {
                // ▼ 아래 따옴표("") 안에 실제 주소를 붙여넣으세요 ▼
                sopLink: "http://esopnon.dtncro.com/login",      // 예: "https://docs.google.com/..."
                manualPdf: "#",    // 기기 매뉴얼 PDF 주소
                logExcel: "#",     // 점검일지 엑셀 주소
                troubleshoot: "https://www.waters.com/nextgen/kr/ko/account/sign-in.html", // 고장 접수 링크
                partsInfo: "#"     // 부품 정보 링크
            }
        };

        const App = () => {
            const [deviceData, setDeviceData] = useState(DEFAULT_DATA);
            const [isEditMode, setIsEditMode] = useState(false);
            const [isUpdating, setIsUpdating] = useState(false);
            const [message, setMessage] = useState(null);
            const [showContactModal, setShowContactModal] = useState(false);
            const [userId, setUserId] = useState(null);

            // 임시 입력 상태 (링크 제외)
            const [tempData, setTempData] = useState(DEFAULT_DATA);

            // 데이터 불러오기
            useEffect(() => {
                if (db) {
                    const unsubscribe = db.collection(COLLECTION_PATH).doc(DOC_ID).onSnapshot((doc) => {
                        if (doc.exists) {
                            // DB 데이터가 있으면 가져오되, 링크는 코드에 적힌 것(DEFAULT_DATA)을 우선 사용하거나 DB 것을 사용할지 결정
                            // 여기서는 편의상 DB에 있는 텍스트 정보 + 코드에 적은 링크를 합칩니다.
                            const dbData = doc.data();
                            setDeviceData(prev => ({
                                ...prev,
                                ...dbData,
                                links: DEFAULT_DATA.links // ★ 링크는 코드에 적힌 값을 강제로 사용 (고정)
                            }));
                        }
                    });
                    auth.signInAnonymously().then(u => setUserId(u.user.uid)).catch(e=>console.log(e));
                    return () => unsubscribe();
                }
            }, []);

            const calculateDDay = (dateString) => {
                if (!dateString) return null;
                const target = new Date(dateString);
                target.setHours(0,0,0,0);
                const today = new Date();
                today.setHours(0,0,0,0);
                return Math.ceil((target - today) / (1000 * 60 * 60 * 24));
            };

            const formatDate = (dateInput) => {
                if (!dateInput) return '미정';
                const date = new Date(dateInput);
                if (isNaN(date)) return '미정';
                return `${date.getFullYear()}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')}`;
            };

            const dDay = calculateDDay(deviceData.nextInspectionDate);
            const dDayText = dDay === null ? '미정' : dDay > 0 ? `D-${dDay}` : dDay === 0 ? 'D-DAY' : `D+${Math.abs(dDay)}`;
            
            const statusColor = {
                '수리중': 'bg-red-500/90',
                '점검중': 'bg-yellow-500/90',
                '사용중': 'bg-blue-500/90',
                '정상 가동 중': 'bg-blue-500/90'
            }[deviceData.status] || 'bg-white/20';
            const dDayColor = dDay === null || dDay > 7 ? 'text-green-600 bg-green-100' : (dDay > 0 ? 'text-yellow-600 bg-yellow-100' : 'text-red-600 bg-red-100');

            const toggleEditMode = () => {
                if (!isEditMode) setTempData(deviceData);
                setIsEditMode(!isEditMode);
            };

            const handleLogInspection = async () => {
                if (!db) return alert("저장하려면 Firebase 설정이 필요합니다.");
                setIsUpdating(true);
                try {
                    const today = new Date();
                    const newLast = today.toISOString().split('T')[0];
                    const nextDate = new Date(today);
                    nextDate.setDate(today.getDate() + parseInt(deviceData.intervalDays || DEFAULT_INTERVAL));
                    const newNext = nextDate.toISOString().split('T')[0];

                    await db.collection(COLLECTION_PATH).doc(DOC_ID).set({
                        lastInspectionDate: newLast,
                        nextInspectionDate: newNext
                    }, { merge: true });
                    setMessage(`✅ 점검 완료! 차기 점검일: ${formatDate(newNext)}`);
                } catch(e) { setMessage(`❌ 실패: ${e.message}`); }
                setIsUpdating(false);
                setTimeout(() => setMessage(null), 3000);
            };

            const handleUpdateInfo = async () => {
                if (!db) return alert("저장하려면 Firebase 설정이 필요합니다.");
                setIsUpdating(true);
                try {
                    // 링크는 저장하지 않고 기기 정보와 주기만 저장
                    await db.collection(COLLECTION_PATH).doc(DOC_ID).set({
                        deviceName: tempData.deviceName,
                        modelName: tempData.modelName,
                        status: tempData.status,
                        serialNo: tempData.serialNo,
                        acquisitionDate: tempData.acquisitionDate,
                        contactPerson: tempData.contactPerson,
                        contactPhone: tempData.contactPhone,
                        contactEmail: tempData.contactEmail,
                        intervalDays: parseInt(tempData.intervalDays)
                    }, { merge: true });
                    setMessage("✅ 정보 저장 완료!");
                } catch(e) { setMessage(`❌ 실패: ${e.message}`); }
                setIsUpdating(false);
                setTimeout(() => setMessage(null), 3000);
            };

            return (
                <div className="max-w-md mx-auto bg-white rounded-[30px] shadow-2xl overflow-hidden border border-gray-100 min-h-[800px] mt-10 mb-10">
                    
                    {/* Header */}
                    <div className="bg-gradient-to-br from-blue-600 to-cyan-500 p-8 text-white rounded-b-[40px] shadow-lg relative z-10">
                        <div className="text-center">
                            <div className={`inline-flex items-center ${statusColor} px-4 py-1.5 rounded-full mb-3 backdrop-blur-md shadow-sm border border-white/20`}>
                                <div className={`w-2 h-2 rounded-full mr-2 ${deviceData.status === '정상 가동 중' ? 'bg-green-400' : 'bg-yellow-400'} animate-pulse`}></div>
                                <span className="text-xs font-bold tracking-wide">{deviceData.status}</span>
                            </div>
                            <h1 className="text-3xl font-extrabold tracking-tight mb-1">{deviceData.deviceName}</h1>
                            <p className="text-sm text-blue-50 font-medium opacity-90">{deviceData.modelName}</p>
                        </div>
                    </div>

                    <div className="px-6 -mt-6 relative z-20 space-y-6 pb-10">
                        
                        {/* SOP Link Card */}
                        <a href={deviceData.links.sopLink} target="_blank" className="block bg-white p-4 rounded-2xl shadow-md border border-yellow-100 flex items-center justify-between hover:shadow-lg transition transform active:scale-[0.98]">
                            <div className="flex items-center">
                                <div className="w-12 h-12 bg-yellow-50 text-yellow-600 rounded-xl flex items-center justify-center text-xl mr-4">
                                    <i className="fa-solid fa-link"></i>
                                </div>
                                <div>
                                    <p className="text-xs font-bold text-yellow-600 uppercase tracking-wider">LINK</p>
                                    <p className="font-bold text-gray-800 text-lg">SOP 접속 링크</p>
                                </div>
                            </div>
                            <div className="w-8 h-8 bg-gray-50 rounded-full flex items-center justify-center text-gray-400"><i className="fa-solid fa-arrow-right"></i></div>
                        </a>

                        {/* 4-Grid Menu */}
                        <div className="grid grid-cols-2 gap-4">
                            {[
                                { title: "기기 매뉴얼", icon: "fa-book", color: "text-blue-600", bg: "bg-blue-50", link: deviceData.links.manualPdf },
                                { title: "기기이력", icon: "fa-clock-rotate-left", color: "text-green-600", bg: "bg-green-50", link: deviceData.links.logExcel },
                                { title: "고장 시 접수", icon: "fa-triangle-exclamation", color: "text-orange-500", bg: "bg-orange-50", link: deviceData.links.troubleshoot },
                                { title: "부품 보유 현황 및 정보", icon: "fa-boxes-stacked", color: "text-purple-600", bg: "bg-purple-50", link: deviceData.links.partsInfo }
                            ].map((item, idx) => (
                                <a key={idx} href={item.link} target="_blank" className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition flex flex-col items-center text-center justify-center h-32">
                                    <div className={`w-12 h-12 ${item.bg} ${item.color} rounded-xl flex items-center justify-center text-2xl mb-3`}>
                                        <i className={`fa-solid ${item.icon}`}></i>
                                    </div>
                                    <span className="font-bold text-gray-800 text-sm leading-tight">{item.title}</span>
                                </a>
                            ))}
                        </div>

                        {/* Inspection Info */}
                        <div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                            <div className="flex justify-between items-center mb-4 pb-4 border-b border-gray-50">
                                <h3 className="font-bold text-gray-800 flex items-center">
                                    <i className="fa-solid fa-calendar-day text-blue-500 mr-2"></i> 점검 일정
                                </h3>
                                <span className={`px-3 py-1 rounded-full text-xs font-extrabold ${dDayColor}`}>{dDayText}</span>
                            </div>
                            <div className="flex justify-between text-sm">
                                <div className="text-center w-1/2 border-r border-gray-100">
                                    <p className="text-xs text-gray-400 mb-1">최근 점검일</p>
                                    <p className="font-semibold text-gray-700">{formatDate(deviceData.lastInspectionDate)}</p>
                                </div>
                                <div className="text-center w-1/2">
                                    <p className="text-xs text-gray-400 mb-1">차기 점검일</p>
                                    <p className="font-bold text-blue-600">{formatDate(deviceData.nextInspectionDate)}</p>
                                </div>
                            </div>
                            <div className="text-center mt-3"><span className="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded">주기: {deviceData.intervalDays}일</span></div>
                        </div>

                        {/* Contact Button */}
                        <button onClick={() => setShowContactModal(true)} className="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-gray-800 transition flex items-center justify-center">
                            <i className="fa-solid fa-headset mr-2"></i> 기기 담당자 연결
                        </button>

                        {/* Admin Toggle */}
                        <div className="text-center pt-4">
                            <button onClick={toggleEditMode} className="text-xs text-gray-400 underline">
                                {isEditMode ? '관리자 모드 닫기' : '관리자 설정'}
                            </button>
                        </div>

                        {/* Admin Panel (링크 수정 기능 제거됨) */}
                        {isEditMode && (
                            <div className="bg-white border-2 border-blue-100 rounded-2xl p-5 shadow-xl animate-fade-in-down">
                                <h3 className="font-bold text-blue-900 mb-4">⚙️ 관리자 설정</h3>
                                {message && <div className="p-2 bg-green-100 text-green-800 rounded mb-2 text-xs font-bold">{message}</div>}
                                
                                <div className="space-y-4">
                                    <button onClick={handleLogInspection} disabled={isUpdating} className="w-full bg-blue-500 text-white py-2 rounded font-bold text-sm">
                                        오늘 날짜로 점검 기록
                                    </button>
                                    <p className="text-xs text-gray-400 text-center -mt-2">클릭 시 다음 점검일이 {deviceData.intervalDays}일 후로 자동 설정됩니다.</p>
                                    <hr />
                                    
                                    <div className="grid grid-cols-2 gap-2">
                                        <input className="form-input" value={tempData.deviceName} onChange={e=>setTempData({...tempData, deviceName:e.target.value})} placeholder="기기명" />
                                        <select className="form-select" value={tempData.status} onChange={e=>setTempData({...tempData, status:e.target.value})}>
                                            <option>정상 가동 중</option><option>수리중</option><option>점검중</option><option>사용중</option>
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <input className="form-input" value={tempData.modelName} onChange={e=>setTempData({...tempData, modelName:e.target.value})} placeholder="모델명" />
                                        <div className="relative">
                                            <input type="number" className="form-input" value={tempData.intervalDays} onChange={e=>setTempData({...tempData, intervalDays:e.target.value})} placeholder="주기" />
                                            <span className="absolute right-3 top-3 text-xs text-gray-400">일</span>
                                        </div>
                                    </div>
                                    {/* 링크 입력 칸 삭제됨: 링크는 코드 상단의 DEFAULT_DATA에서 수정하세요 */}
                                    
                                    <input className="form-input" value={tempData.contactPerson} onChange={e=>setTempData({...tempData, contactPerson:e.target.value})} placeholder="담당자 이름" />
                                    <div className="grid grid-cols-2 gap-2">
                                        <input className="form-input" value={tempData.contactPhone} onChange={e=>setTempData({...tempData, contactPhone:e.target.value})} placeholder="연락처" />
                                        <input className="form-input" value={tempData.contactEmail} onChange={e=>setTempData({...tempData, contactEmail:e.target.value})} placeholder="이메일" />
                                    </div>
                                    
                                    <button onClick={handleUpdateInfo} disabled={isUpdating} className="w-full bg-gray-800 text-white py-2 rounded font-bold text-sm">
                                        전체 정보 저장
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Modal */}
                    {showContactModal && (
                        <div className="fixed inset-0 bg-black/60 flex justify-center items-center z-50 p-4" onClick={() => setShowContactModal(false)}>
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4">기기 담당자</h3>
                                <div className="space-y-3 text-gray-700">
                                    <p><strong>이름:</strong> {deviceData.contactPerson}</p>
                                    <p><strong>연락처:</strong> <a href={`tel:${deviceData.contactPhone}`} className="text-blue-500">{deviceData.contactPhone}</a></p>
                                    <p><strong>이메일:</strong> <a href={`mailto:${deviceData.contactEmail}`} className="text-blue-500">{deviceData.contactEmail}</a></p>
                                </div>
                                <button onClick={() => setShowContactModal(false)} className="mt-6 w-full py-2 bg-gray-900 text-white rounded-xl">닫기</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
